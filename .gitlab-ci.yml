stages: 
  - build 
  - test 
  - deploy 
 
image: docker:stable
 
services: 
  - docker:dind 
 
variables: 
  DOCKER_DRIVER: overlay2 
  DOCKER_TLS_CERTDIR: "" 
 
before_script: 
  - apk update 
  - apk add --no-cache curl 
  - curl -L "https://github.com/docker/compose/releases/download/latest/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/docker-compose 
  - chmod +x /usr/local/docker-compose 
  - if [ ! -f /usr/local/docker-compose ]; then echo "Docker Compose download failed"; exit 1; fi 
  - docker info 
  - docker-compose --version
 
build: 
  stage: build 
  tags:  
    - docker  
    - linux  
    - nodejs 
  script: 
    - docker-compose build --no-cache 
 
test: 
  stage: test 
  script: 
    - docker-compose up -d 
    - docker-compose exec service1 npm install 
    - docker-compose exec service1 npm test 
    - docker-compose exec service2 npm install 
    - docker-compose exec service2 npm run test 
  after_script: 
    - docker-compose down 
 
deploy: 
  stage: deploy 
  script: 
    - docker-compose up -d 
  only: 
    - main